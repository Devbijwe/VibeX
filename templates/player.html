<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='assets/icons/logo.svg') }}" />
    <title>{{pageTitle}} | VibeX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static',filename='css/player.css') }}">
</head>

<body>
    <div class="overflow-hidden">
        <!-- Dark Mode Toggle -->
        <div class="absolute right-4 top-4">
            <div id="dark-mode-toggle" class="cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white hidden dark:block" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-[#0A1122] block dark:hidden" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </div>
        </div>

        <!-- Background Video -->
        <video id="bg-video" autoplay loop muted playsinline
            class="absolute inset-0 w-full h-screen object-cover z-0"></video>

        <!-- Lyrics -->
        <div class="flex items-center justify-center h-screen">
            <div class="relative self-end mb-4 w-player w-full opacity-100 flex flex-col rounded-xl">
                <h1 id="lyrics-container"
                    class="h-full font-black text-2xl p-4 overflow-y-auto text-white dark:text-gray-100 pl-10 md:pl-24 text-start animate-fade-in">
                    Lyrics can't be loaded.
                </h1>
            </div>
        </div>

        <!-- Player Controls -->
        <div class="relative self-end mb-4 b-16 w-player w-full opacity-100 flex flex-col rounded-xl">
            <div class="px-10 pt-10 pb-4 flex items-center z-50">
                <div class="pl-5 md:pl-24 flex flex-col">
                    <span id="songName" class="font-sans text-lg font-medium leading-7 text-slate-900 dark:text-white"></span>
                    <span id="artist" class="font-sans text-base font-medium leading-6 text-gray-500 dark:text-gray-400"></span>
                    <span id="album" class="font-sans text-base font-medium leading-6 text-gray-500 dark:text-gray-400"></span>
                </div>
            </div>

            <div class="w-full flex flex-col px-10 pb-6 z-50">
                <input type="range" id="song-percentage-played" value="0" min="0" max="100"
                    class="amplitude-song-slider mb-3" step=".1" />
                <div class="flex w-full justify-between">
                    <span id="current-song-duration" class="amplitude-current-time text-xs font-sans tracking-wide font-medium text-sky-500 dark:text-sky-300">--:--</span>
                    <span id="total-song-duration" class="amplitude-duration-time text-xs font-sans tracking-wide font-medium text-gray-500">--:--</span>
                </div>
            </div>

            <div class="h-control-panel opacity-100 px-10 rounded-b-xl bg-control-panel-light-background border-t border-gray-200 flex items-center justify-between z-50 dark:bg-control-panel-dark-background dark:border-gray-900">
                <div id="song-saved" class="cursor-pointer">
                    <!-- Save Icon -->
                </div>
                <div class="cursor-pointer amplitude-shuffle" id="shuffle-btn">
                    <!-- Shuffle Icon -->
                </div>
                <div class="cursor-pointer amplitude-prev" id="prev-btn">
                    <!-- Prev Icon -->
                </div>
                <div id="btn-play-pause"
                    class="cursor-pointer amplitude-play-pause w-24 h-24 rounded-full bg-white border border-play-pause-light-border shadow-xl flex items-center justify-center dark:bg-play-pause-dark-background dark:border-play-pause-dark-border">
                    <!-- Play Icon -->
                    <svg id="play-icon" class="ml-[10px]" width="31" height="37" viewBox="0 0 31 37" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M29.6901 16.6608L4.00209 0.747111C2.12875 -0.476923 0.599998 0.421814 0.599998 2.75545V33.643C0.599998 35.9728 2.12747 36.8805 4.00209 35.6514L29.6901 19.7402C29.6901 19.7402 30.6043 19.0973 30.6043 18.2012C30.6043 17.3024 29.6901 16.6608 29.6901 16.6608Z"
                            class="fill-slate-500 dark:fill-slate-400" />
                    </svg>
                </div>
                <div class="cursor-pointer amplitude-next" id="next-btn">
                    <!-- Next Icon -->
                </div>
                <div class="cursor-pointer amplitude-repeat-song" id="repeat-btn">
                    <!-- Repeat Icon -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // -------------------- Variables --------------------
        let audio = new Audio();
        let lyricsData = [];
        let nextSongData = null;
        const bgVideo = document.getElementById('bg-video');
        const progressBar = document.getElementById("song-percentage-played");
        let playPauseButton = document.getElementById("btn-play-pause");
        const totalTimeofSong = document.getElementById("total-song-duration");
        const currentTimeofSong = document.getElementById("current-song-duration");
        const lyricsContainer = document.getElementById("lyrics-container");
        const songIdToFetch = "{{song_id}}";
        let isRepeat = false;
        let isShuffle = false;

        // -------------------- Audio & Song Loader --------------------
        async function loadSong(songId, autoPlay = true) {
            try {
                const response = await fetch(`/get-song/${songId}`);
                const data = await response.json();

                const songData = {
                    songName: data.song.songName,
                    artist: data.song.songArtist,
                    album: data.song.songAlbum,
                    lyricsUrl: `/download/song-lyrics/${songId}`,
                    audioUrl: `/download/song-audio/${songId}`,
                    bgVideoUrl: `/download/song-bg/${songId}`,
                };

                // -------------------- Audio --------------------
                audio.src = songData.audioUrl;
                if (autoPlay) audio.play();

                // -------------------- Song Info --------------------
                document.getElementById('songName').textContent = songData.songName;
                document.getElementById('artist').textContent = songData.artist;
                document.getElementById('album').textContent = songData.album;

                // -------------------- Background Video --------------------
                bgVideo.src = songData.bgVideoUrl;
                if (autoPlay) bgVideo.play();

                // -------------------- Lyrics --------------------
                lyricsData = await fetchLyrics(songData.lyricsUrl);

                // -------------------- Prefetch Next Song --------------------
                nextSongData = await fetchNextSong(songId);

            } catch (error) {
                console.error("Error loading song:", error);
            }
        }

        // -------------------- Fetch Lyrics --------------------
        async function fetchLyrics(url) {
            try {
                const res = await fetch(url);
                const text = await res.text();
                const lines = text.split('\n');
                const data = [];
                lines.forEach(line => {
                    const match = line.match(/^\[(\d+:\d+\.\d+)\](.*)/);
                    if (match) data.push({ timestamp: match[1], lyrics: match[2].trim() });
                });
                return data;
            } catch (err) {
                console.error("Lyrics fetch failed", err);
                return [];
            }
        }

        // -------------------- Prefetch Next Song --------------------
        async function fetchNextSong(currentId) {
            try {
                const url = `/get-next-song/${currentId}`; // Implement this route in Flask
                const response = await fetch(url);
                if (!response.ok) return null;
                return await response.json();
            } catch { return null; }
        }

        // -------------------- Controls --------------------
        function togglePlayPause() {
            if (audio.paused) audio.play();
            else audio.pause();
        }

        document.getElementById('btn-play-pause').addEventListener('click', togglePlayPause);
        document.getElementById('next-btn').addEventListener('click', () => {
            if (nextSongData) {
                loadSong(nextSongData.id);
            }
        });
        document.getElementById('prev-btn').addEventListener('click', () => {
            window.location.href = `/play?song_id={{song_id}}&action=prev`;
        });
        document.getElementById('repeat-btn').addEventListener('click', () => { isRepeat = !isRepeat; });
        document.getElementById('shuffle-btn').addEventListener('click', () => { isShuffle = !isShuffle; });

        // -------------------- Progress & Lyrics --------------------
        audio.addEventListener('timeupdate', () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.value = progress;

            currentTimeofSong.textContent = new Date(audio.currentTime * 1000).toISOString().substr(14, 5);
            totalTimeofSong.textContent = new Date(audio.duration * 1000).toISOString().substr(14, 5);

            updateLyrics(audio.currentTime);
        });

        progressBar.addEventListener('input', () => {
            audio.currentTime = (progressBar.value / 100) * audio.duration;
        });

        audio.addEventListener('ended', () => {
            if (isRepeat) audio.play();
            else document.getElementById('next-btn').click();
        });

        function parseTimestamp(ts) {
            const [min, sec] = ts.split(':').map(Number);
            return min * 60 + sec;
        }

        function updateLyrics(currentTime) {
            if (!lyricsData || lyricsData.length === 0) return;
            let currentIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (parseTimestamp(lyricsData[i].timestamp) <= currentTime) currentIndex = i;
            }

            if (currentIndex === -1) return;
            let html = '';
            for (let i = Math.max(0, currentIndex - 6); i < currentIndex; i++) {
                html += `<div class="opacity-50">${lyricsData[i].lyrics}</div>`;
            }
            html += `<div class="text-pink-500 font-bold">${lyricsData[currentIndex].lyrics}</div>`;
            lyricsContainer.innerHTML = html;
        }

        // -------------------- Dark Mode --------------------
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        document.getElementById('dark-mode-toggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

        // -------------------- Initial Load --------------------
        loadSong(songIdToFetch);
    </script>
</body>
</html>
